# Generating Input Data for the System Tests

The system tests rely on `.mat` input files that are presently generated through a series of MATLAB function calls and scripts. This directory contains the functionality to automatically (re)generate this input data locally, which serves two purposes:
- It means that the `.mat` _input_ files do not need to be uploaded and fetched from Zenodo each time the system tests are to be run. They can be generated locally instead. Note that the reference output files corresponding to these inputs still need to be downloaded from Zenodo.
- We are able to reliably track changes to the way we decide to handle the inputs to `tdms`, and the system tests now also provide us with a check against unexpected behaviours due to input changes.

## (Re)generation of the Data

At a glance, (re)generating the input data for a particular test case, `arc_tc`, is a three step process:
1. Determine variables, filenames, and the particular setup of `arc_tc`. For example, is an illumination file required? What are the spatial obstacles? What is the solver method? This information is stored in a `config_tc.yaml` file.
1. Call the `run_bscan.m` function (and appropriate supporting functions in the `./matlab` folder) using the information provided from the first step to produce the `.mat` input files. Each test case is also pointed to an input file (`input_file_tc.m`) which defines test-specific variables (domain size, number of period cells, material properties, etc) which are too complex to specify in a `.yaml` file.
1. Clean up the auxillary `.mat` files that are generated by this process. In particular, any `gridfiles.mat`, illumination files, or other `.mat` files that are temporarily created when generating the input `.mat` file.

## Contents of this Directory (and subdirectories)

The `run_bscan` function is inside the `bscan/` directory.

The `matlab/` directory contains functions that `run_bscan` will need to call on during the creation of the input data. This in particular includes the `iteratefdtd_matrix` function, which does the majority of the work in setting up gridfiles, illumination files, and the `.mat` inputs themselves.

The `generate_test_input.py` file contains `.py` files that the system tests can invoke to regenerate the input data. Since the system test framework uses `pytest`, but the data generation requires `MATLAB` (for now), we use `Python` to read in and process the information that each test requires, and then call `run_bscan` with the appropriate commands from within Python.

The `regenerate_all.py` file will work through all of the `config_tc.yaml` files in the directory and regenerate the input `.mat` data corresponding to each.

The remaining `config_XX.yaml` and `input_file_XX.m` files are as mentioned in [the previous section](#regeneration-of-the-data). These contain the information about each test that Python and `run_bscan` will need to regenerate the input files.
