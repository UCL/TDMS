<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TDMS: Developer documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">TDMS
   </div>
   <div id="projectbrief">Time Domain Maxwell Solver</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Developer documentation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_developers"></a> Welcome to the developer documentation for TDMS, the Time Domain Maxwell Solver. These pages contain the C++ API documentation as well as some other useful information for developers.</p>
<ul>
<li>üê£ If you are a new user, you probably want to start with the project's <a href="https://github.com/UCL/TDMS/blob/main/README.md">README.md</a> on github. There are installation and "getting started" instructions.</li>
<li>üêõ If you've spotted a bug or want to request a feature, we have a short <a href="https://github.com/UCL/TDMS/blob/main/CONTRIBUTING.md">CONTRIBUTING.md</a>. Then please <a href="https://github.com/UCL/TDMS/issues">send an issue through github</a>.</li>
<li>If you want to contribute to the development (üöÄ!) and have read <a href="https://github.com/UCL/TDMS/blob/main/CONTRIBUTING.md">CONTRIBUTING.md</a>, you're in the right place.</li>
</ul>
<h1><a class="anchor" id="autotoc_md1"></a>
What?</h1>
<p>The physics background and numerical methods used by TDMS are described in <a href="https://github.com/UCL/TDMS/blob/gh-doc/masterdoc.pdf">this pdf document</a> (the source is in <a href="https://github.com/UCL/TDMS/blob/main/doc/latex">doc/latex</a>). In terms of the code, <code>tdms</code> is a C++ binary that can be installed in your path. We build with <a href="https://cmake.org/">CMake</a> to be moderately platform-independent. We run continuous integration builds and tests on Windows, Ubuntu, and MacOS.</p>
<h2><a class="anchor" id="autotoc_md2"></a>
Dependencies</h2>
<p>We depend on ...</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/OpenMP">OpenMP</a> for parallelization.</li>
<li><a href="https://www.fftw.org/">fftw</a> to calculate numerical derivatives (<a class="el" href="numerical__derivative_8h.html" title="Functions to calculate the numerical derivatives.">numerical_derivative.h</a>)</li>
<li><a href="https://github.com/gabime/spdlog">spdlog</a> for logging (this is installed automatically by a CMake <a href="https://cmake.org/cmake/help/latest/module/FetchContent.html">FetchContent</a> if not found).</li>
<li><a href="https://www.mathworks.com/products/matlab.html">MATLAB</a> since we read in and write out MATLAB format files. We are actually thinking of removing this as a strict dependency (<a href="https://github.com/UCL/TDMS/issues/70">#70</a>).</li>
</ul>
<h2><a class="anchor" id="autotoc_md3"></a>
Code style and other admin</h2>
<p>We try to stick to <a href="https://google.github.io/styleguide/cppguide.html">Google style C++</a> wherever practicable. There is one exception: we prefer <code>#pragma once</code> at the top of each header (because it's one line rather than three and is almost the standard anyway).</p>
<p>Please keep doxygen-style comments in the <b>headers</b>. </p><div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * Add two numbers together</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * @param a: real number</span></div>
<div class="line"><span class="comment"> * @param b: real number</span></div>
<div class="line"><span class="comment"> * @return sum of a and b</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">double</span> add(<span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b);</div>
</div><!-- fragment --><p> And please document the header itself with at least: </p><div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * @file filename.h</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Describe the functions/classes in here.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor"> #pragma once</span></div>
</div><!-- fragment --><p> You can quickly check the documentation for your changes look correct with: </p><div class="fragment"><div class="line">doxygen doc/Doxygen</div>
<div class="line">firefox html/index.html # or your web browser of choice</div>
</div><!-- fragment --><p> You should be able to find and read what you've changed. Don't worry about doxygen for the source files (although obviously please do write helpful comments there). We <em>have</em> been putting doxygen comments in the <a href="#unit-testing">unit-test</a> source files wherever sensible.</p>
<p>For Python code (e.g. in the <a href="#system-tests">system tests</a>) we use <a href="https://black.readthedocs.io/en/stable/">black</a> to enforce the code style. To apply automatic code styling to staged changes in git we recommend <a href="https://pre-commit.com/"><code>pre-commit</code></a>. If you don't have it already: </p><div class="fragment"><div class="line">python -m pip install pre-commit</div>
</div><!-- fragment --><p>Then from the root repository directory you can add the pre-commit hooks with </p><div class="fragment"><div class="line">ls .git/hooks</div>
<div class="line">pre-commit install</div>
<div class="line">ls .git/hooks</div>
</div><!-- fragment --><h2><a class="anchor" id="compiling"></a>
Compiling and debugging</h2>
<p>Once you've checked the code out, compile with: </p><div class="fragment"><div class="line">cd tdms</div>
<div class="line">mkdir build; cd build</div>
<div class="line">cmake .. \</div>
<div class="line"># -DMatlab_ROOT_DIR=/usr/local/MATLAB/R2019b/ \</div>
<div class="line"># -DFFTW_ROOT=/usr/local/fftw3/ \</div>
<div class="line"># -DCMAKE_INSTALL_PREFIX=$HOME/.local/</div>
<div class="line">make install</div>
</div><!-- fragment --><p> You may need to help CMake find MATLAB/fftw etc.</p>
<ul>
<li>By default, build testing is turned off. You can turn it on with <code>-DBUILD_TESTING=ON</code>.</li>
<li>Also by default, debug printout is off. Turn on with <code>-DCMAKE_BUILD_TYPE=Debug</code> or manually at some specific place in the code with: <div class="fragment"><div class="line"><span class="preprocessor">#include &lt;spdlog/spdlog.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">spdlog::set_level(spdlog::level::debug);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">spdlog::debug(<span class="stringliteral">&quot;Send help&quot;</span>);</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md4"></a>
Compiling on UCL's Myriad cluster</h2>
<p>&lt;details&gt;</p>
<blockquote class="doxtable">
<p><b>Warning</b> These instructions are a bit experimental. Please use with care (and report anything that's wrong here)! </p>
</blockquote>
<p>If you want to test changes on UCL's <a href="https://www.rc.ucl.ac.uk/docs/Clusters/Myriad/">Myriad</a> (and/or don't have MATLAB on your pesonal machine) you can try these instructions. Firstly, you will probably want to <a href="https://stackoverflow.com/questions/12257968/">forward your ssh agent</a> for your github ssh key. To do this, you first need to run the following your <em>local</em> machine: </p><div class="fragment"><div class="line">ssh-add -L # check your ssh agent is running</div>
<div class="line">ssh-add /path/to/your/github/key/id_rsa</div>
<div class="line">ssh -o ForwardAgent=yes your_user@myriad.rc.ucl.ac.uk</div>
</div><!-- fragment --><p>And once you're on Myriad:</p>
<div class="fragment"><div class="line">git clone git@github.com:UCL/TDMS.git</div>
<div class="line"> </div>
<div class="line">module purge</div>
<div class="line">module load beta-modules</div>
<div class="line">module load gcc-libs/9.2.0 compilers/gnu/9.2.0 xorg-utils matlab/full/r2021a/9.10 fftw/3.3.6-pl2/gnu-4.9.2 cmake/3.21.1</div>
<div class="line">cd TDMS/tdms</div>
<div class="line">mkdir build; cd build</div>
<div class="line">cmake .. \</div>
<div class="line"># -DGIT_SSH=ON</div>
<div class="line">make install</div>
</div><!-- fragment --><p>If you get the following error (or similar) </p><div class="fragment"><div class="line">fatal: unable to access &#39;https://github.com/gabime/spdlog/&#39;: error setting certificate verify locations:</div>
<div class="line">CAfile: /etc/ssl/certs/ca-certificates.crt</div>
<div class="line">CApath: none</div>
</div><!-- fragment --><p> it's because the MATLAB module is interfering with the SSL certificates (and we clone over https by default). This issue is known and reported. As a workaround, we've added the build option <code>-DGIT_SSH=ON</code> to switch to <code>git clone</code> over ssh instead.</p>
<p>&lt;/details&gt;</p>
<h1><a class="anchor" id="autotoc_md5"></a>
Where's the main?</h1>
<p>The C++ <code>main</code> function is in <code><a class="el" href="main_8cpp.html" title="The main function. Launches TDMS.">main.cpp</a></code> however the main algorithm code is in the <code>execute()</code> method of the <code><a class="el" href="classSimulationManager.html" title="Manages the physics of TDMS and the simulation loop itself.">SimulationManager</a></code> class, in <code><a class="el" href="execute__simulation_8cpp.html" title="Code for performing the time-stepping algorithm for the physical process TDMS models.">execute_simulation.cpp</a></code>.</p>
<p>Broadly speaking, the <code>main</code> function - and thus a call to (or execution of) <code>tdms</code> - can be broken down into the following steps:</p><ol type="1">
<li>Parse the input arguments</li>
</ol>
<ol type="1">
<li><a href="#initialisation-step-2">Prepare the simulation</a> by creating an instance of <code><a class="el" href="classSimulationManager.html" title="Manages the physics of TDMS and the simulation loop itself.">SimulationManager</a></code></li>
</ol>
<ol type="1">
<li><a href="#running-the-main-loop-step-3">Run the <em>main loop</em></a>. The <em>main loop</em> is meant to mean "the (implementation of) the time-stepping algorithm which TDMS uses", and is contained in the <code>execute()</code> method of the <code><a class="el" href="classSimulationManager.html" title="Manages the physics of TDMS and the simulation loop itself.">SimulationManager</a></code> class.</li>
</ol>
<ol type="1">
<li><a href="#post-processing-step-4">Perform post-loop processing</a> on the outputs, having completed the main loop (extraction of phasors, computing derived quantities, etc).</li>
</ol>
<ol type="1">
<li><a href="#write-out-and-tear-down-step-5">Write the outputs</a> and tear-down memory.</li>
</ol>
<p>The <code><a class="el" href="classSimulationManager.html" title="Manages the physics of TDMS and the simulation loop itself.">SimulationManager</a></code> class governs steps 2 through 5.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Code organisation of the TDMS algorithm</h1>
<p>An instance of <code><a class="el" href="classSimulationManager.html" title="Manages the physics of TDMS and the simulation loop itself.">SimulationManager</a></code> essentially supports one <code>tdms</code> simulation, however functionality is divided across its member variables. These objects themselves group variables by functionality, purpose, and necessary scope. The list below provides a description of these objects (with parentheses denoting the member name in the <code><a class="el" href="classSimulationManager.html" title="Manages the physics of TDMS and the simulation loop itself.">SimulationManager</a></code> instance):</p><ul>
<li><code><a class="el" href="classObjectsFromInfile.html" title="Class that handles the creation of C++ arrays from the matrices passed in an InputMatrices object,...">ObjectsFromInfile</a></code> (<code>inputs</code>): Handles conversion of any input arrays to native <code>C++</code> objects, and any variables that are derived directly from the input file supplied to <code>tdms</code> on the command line.</li>
<li><code><a class="el" href="classOutputMatrices.html" title="Handles the data that is written to the output file, and the associated native C++ classes and dataty...">OutputMatrices</a></code> (<code>outputs</code>): Handles data storage for the outputs and the process of writing the output file.</li>
<li><code><a class="el" href="classPSTDVariables.html" title="Handles allocation and tear-down of memory/variables required when running a PSTD simulation....">PSTDVariables</a></code> (<code>PSTD</code>) and <code><a class="el" href="classFDTDBootstrapper.html" title="Class that handles the FDTD bootstrapping variables.">FDTDBootstrapper</a></code> (<code>FDTD</code>): Handle variables that are only required for the pseudo-spectral and finite-difference solver methods, respectively.</li>
<li><code><a class="el" href="classLoopTimers.html" title="Class that handles the timers that monitor the performance of the program during the main loop,...">LoopTimers</a></code> (<code>timers</code>): Controls timing (and logging execution times) of the main loop and subprocesses therein.</li>
</ul>
<p>The role of <code><a class="el" href="classSimulationManager.html" title="Manages the physics of TDMS and the simulation loop itself.">SimulationManager</a></code> is to handle how these objects interact in the main loop.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Initialisation (step 2)</h2>
<p><code><a class="el" href="classSimulationManager.html" title="Manages the physics of TDMS and the simulation loop itself.">SimulationManager</a></code> instances begin by initialising the <code>inputs</code> attribute. Based on this attribute, they set up <code>PSTD</code>/<code>FDTD</code> variables and prepare the <code>outputs</code> object for writing. Some members of the <code>outputs</code> objects are used as the buffer for the field and phasor data whilst the main loop is running, with the final state of this buffer being the output values. Other attributes of the <code>outputs</code> object that require information <em>from</em> the main loop are prepared (dimensions are determined, etc) at this stage but not set.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
Running the Main Loop (step 3)</h2>
<p>Once initialised, the <code>execute()</code> method can be called. This will create an instance of <code><a class="el" href="classLoopVariables.html" title="Handles the setup of variables that will be scoped to the main iteration loop, however which require ...">LoopVariables</a></code> that is scoped to this function; which in turn sets up the variables that are required in the main loop but not needed elsewhere. This avoids bloating the <code>execute()</code> method with a large number of variable declarations and setup, as well as simplifying tear-down at the end of the loop. <code>timers</code> track the speed of execution of the main loop, and report to the logging.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Post-Processing (step 4)</h2>
<p>Upon completing <code>execute()</code> successfully, the <code>post_loop_processing()</code> method of <code><a class="el" href="classSimulationManager.html" title="Manages the physics of TDMS and the simulation loop itself.">SimulationManager</a></code> writes the data to the <code>outputs</code> attributes that were not used as buffers during the main loop.</p>
<h2><a class="anchor" id="autotoc_md10"></a>
Write out and Tear Down (step 5)</h2>
<p>From here, the <code>write_outputs()</code> method exports the data in <code>outputs</code> to the desired file.</p>
<p>At this point, the instance of <code><a class="el" href="classSimulationManager.html" title="Manages the physics of TDMS and the simulation loop itself.">SimulationManager</a></code> can be allowed to go out of scope. In practice, <code>main()</code> terminates here and the destructor handles the tear-down of <code>MATLAB</code> memory blocks.</p>
<h1><a class="anchor" id="autotoc_md11"></a>
Testing</h1>
<p>We have two <a href="https://en.wikipedia.org/wiki/Software_testing#Testing_levels">levels of tests</a>: unit tests, and full system tests.</p>
<h2><a class="anchor" id="unit-testing"></a>
Unit</h2>
<p>The unit tests use <a href="https://github.com/catchorg/Catch2/blob/devel/docs/Readme.md#top">catch2</a> macros. See <a href="https://github.com/UCL/TDMS/blob/main/tdms/tests/unit">tests/unit</a> for good examples in the actual test code.</p>
<p>To write a new test, as a rough sketch you need:</p>
<div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * @file test_file.cpp</span></div>
<div class="line"><span class="comment"> * @brief Short description of the tests.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#include &quot;things_to_be_tested.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;catch2/catch_test_macros.hpp&gt;</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * @brief Detailed description of the testing.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Maybe go into details about the test setup.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line">TEST_CASE(<span class="stringliteral">&quot;Write a meaningful test case name&quot;</span>) {</div>
<div class="line">    <span class="comment">// set up function calls or whatever</span></div>
<div class="line">    REQUIRE_THROW(&lt;something&gt;);</div>
<div class="line">    CHECK(&lt;something&gt;);</div>
<div class="line">}</div>
</div><!-- fragment --><p> The doxygen-style comments will be included in this developer documentation.</p>
<p>To run the unit tests, <a href="#compiling">compile</a> with <code>-DBUILD_TESTING=ON</code>. Then run <code>ctest</code> from the build directory or execute the test executable <code>./tdms_tests</code>.</p>
<p>It's good practice, and reassuring for your pull-request reviewers, if new C++ functionality is at covered by unit tests.</p>
<h2><a class="anchor" id="system-tests"></a>
System</h2>
<p>The full system tests are written in Python 3, and call the <code>tdms</code> executable for known inputs and compare to expected outputs. We use <a href="https://docs.pytest.org">pytest</a> and our example data is provided as zip files on <a href="https://zenodo.org/">zenodo</a>.</p>
<p>There are a few <a href="https://github.com/UCL/TDMS/blob/main/tdms/tests/requirements.txt">python packages you will need</a> before running the tests so run: </p><div class="fragment"><div class="line">python -m pip install -r tdms/tests/requirements.txt</div>
</div><!-- fragment --><p> if you don't already have them.</p>
<p>When you run the tests for the first time, the example data will be downloaded to <code>tdms/tests/system/data</code> (which is <a href="https://github.com/UCL/TDMS/blob/main/.gitignore">ignored by git</a>). Subsequent runs of the test will not re-download unless you manually delete the zip file.</p>
<p>A good example of running the <code>tdms</code> executable for a given input and expected output is <a href="https://github.com/UCL/TDMS/blob/main/tdms/tests/system/test_arc01.py">test_arc01.py</a></p>
<p>You need to <a href="#compiling">compile</a> <code>tdms</code>, then the system tests can be run, e.g. from the build directory:</p>
<div class="fragment"><div class="line">pytest ../tests/system/</div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
