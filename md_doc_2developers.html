<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TDMS: Developer documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">TDMS
   </div>
   <div id="projectbrief">Time Domain Maxwell Solver</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md_doc_2developers.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Developer documentation </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md15"></a></p>
<p>Welcome to the developer documentation for TDMS, the Time Domain Maxwell Solver. These pages contain the C++ API documentation as well as some other useful information for developers.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md16"></a>
Developers' introduction to TDMS</h1>
<p>The physics background and numerical methods used by TDMS are described in <a href="https://github.com/UCL/TDMS/blob/gh-doc/masterdoc.pdf">this pdf document</a> (the source is in <a href="https://github.com/UCL/TDMS/blob/main/doc/latex">doc/latex</a>). In terms of the code, <span class="tt">tdms</span> is a C++ binary that can be installed in the <span class="tt">PATH</span>. We build with <a href="https://cmake.org/">CMake</a> to be moderately platform-independent. We run continuous integration builds and tests on Windows, Ubuntu, and MacOS.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md17"></a>
Dependencies</h1>
<p>We depend on ...</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/OpenMP">OpenMP</a> for parallelization.</li>
<li><a href="https://www.fftw.org/">fftw</a> to calculate numerical derivatives (<a class="el" href="numerical__derivative_8h.html" title="Functions to calculate the numerical derivatives.">numerical_derivative.h</a>)</li>
<li><a href="https://github.com/gabime/spdlog">spdlog</a> for logging (this is installed automatically by a CMake <a href="https://cmake.org/cmake/help/latest/module/FetchContent.html">FetchContent</a> if not found).</li>
<li><a href="https://www.mathworks.com/products/matlab.html">MATLAB</a> since we read in and write out MATLAB format files. We are actually thinking of removing this as a strict dependency (<a href="https://github.com/UCL/TDMS/issues/70">#70</a>).</li>
<li><a href="https://portal.hdfgroup.org/display/HDF5/HDF5+CPP+Reference+Manuals">HDF5</a> for TDMS versions newer than v1.0.1 or for building the <span class="tt">HEAD</span> of <span class="tt">main</span>. See <a href="https://github.com/UCL/TDMS/issues/181">issue #181</a> for more details.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md18"></a>
Versions</h2>
<p>We follow <a href="https://semver.org">semantic versioning</a>: major, minor, patch. Major versions may contain changes to the API and UI, minor versions contain new features but preserve backwards-compatibility of UI, patches are bugfixes.</p>
<p>So (for example) version v1.2.0 is major version 1, minor version 2, and the zeroth patch. v1.2.0 will be backwards-compatible with v1.1.99.</p>
<p><b>Mechanics</b>: Version control is via <span class="tt">git tag</span>s on the <span class="tt">main</span> branch and propagated to the C++ source <a href="https://github.com/UCL/TDMS/blob/main/tdms/cmake/version_from_git.cmake">code via CMake</a>. Release notes are kept in the <a href="https://github.com/UCL/TDMS/releases">GitHub release page</a>. If release hotfixes or release bugfixes are needed and <span class="tt">main</span> has advanced too far to follow the rules of a semantic version patch, then make a release branch <span class="tt">release/vX.Y</span> at (or close to) the tag of the version to patch. The release branch can have the important fixes <span class="tt">git cherry-pick</span>ed over and can be tagged with a patch version (independent of the changes in <span class="tt">main</span>). More details on this procedure are in <a href="https://github.com/UCL/TDMS/issues/317">Issue #317</a>.</p>
<p>As well as official releases, a placeholder "version" is assigned to every commit on every development branch, or can be supplied at compile-time (which takes the highest precedence).</p>
<div class="fragment"><div class="line">$ cmake .. &lt;usual cmake options&gt; -DTDMS_VERSION=this_version_string_will_be_highest_priority</div>
<div class="line">$ make install</div>
<div class="line">$ tdms --version</div>
<div class="line">TDMS version: this_version_string_will_be_highest_priority</div>
</div><!-- fragment --><p>If on a development branch then the placeholder version is <span class="tt">&lt;branchname&gt;_&lt;tag&gt;</span> if tagged, or <span class="tt">&lt;branchname&gt;_&lt;commit hash&gt;</span> if not tagged. This is useful when debugging problems introduced between commits (with the assistance of <span class="tt">git bisect</span>).</p>
<div class="fragment"><div class="line">$ git checkout myfeaturebranch</div>
<div class="line">$ cmake ..</div>
<div class="line">$ make install</div>
<div class="line">$ tdms --version</div>
<div class="line">TDMS version: myfeaturebranch_a341ab</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="code-style-and-doxygen"></a>
Code style and other admin</h2>
<p>We try to stick to <a href="https://google.github.io/styleguide/cppguide.html">Google style C++</a> wherever practicable. There is one exception: we prefer <span class="tt">#pragma once</span> at the top of each header (because it's one line rather than three and is almost the standard anyway).</p>
<p>Please keep doxygen-style comments in the <b>headers</b>. </p><div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * Add two numbers together</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * @param a: real number</span></div>
<div class="line"><span class="comment"> * @param b: real number</span></div>
<div class="line"><span class="comment"> * @return sum of a and b</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">double</span> add(<span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b);</div>
</div><!-- fragment --><p> And please document the header itself with at least: </p><div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * @file filename.h</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Describe the functions/classes in here.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor"> #pragma once</span></div>
</div><!-- fragment --><p> You can quickly check the documentation for your changes look correct with: </p><div class="fragment"><div class="line">doxygen doc/Doxygen</div>
<div class="line">firefox html/index.html # or your web browser of choice</div>
</div><!-- fragment --><p> You should be able to find and read what you've changed. Don't worry about doxygen for the source files (although obviously please do write helpful comments there). We <em>have</em> been putting doxygen comments in the <a class="el" href="#unit-testing">unit-test</a> source files wherever sensible.</p>
<h2 class="doxsection"><a class="anchor" id="pre-commit"></a>
Linters and automatic code style</h2>
<p>For C++ we've found <a href="https://clang.llvm.org/docs/ClangFormat.html">ClangFormat</a> works well. For Python code (e.g. in the <a class="el" href="#system-tests">system tests</a>) we use <a href="https://black.readthedocs.io/en/stable/">black</a>.</p>
<p>To apply automatic code styling to staged changes in git we recommend <a href="https://pre-commit.com/"><span class="tt">pre-commit</span></a>. If you don't have it already: </p><div class="fragment"><div class="line">python -m pip install pre-commit</div>
</div><!-- fragment --><p>Then from the root repository directory you can add the pre-commit hooks with </p><div class="fragment"><div class="line">ls .git/hooks</div>
<div class="line">pre-commit install</div>
<div class="line">ls .git/hooks</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="compiling"></a>
Compiling and debugging</h1>
<p>Once you've checked the code out, compile following the <a href="https://github-pages.ucl.ac.uk/TDMS">user instructions</a>. If you're building the <span class="tt">HEAD</span> of <span class="tt">main</span> you'll also need to install HDF5 with:</p>
<div class="fragment"><div class="line">sudo apt install libhdf5-dev</div>
</div><!-- fragment --><p> on Linux or</p>
<div class="fragment"><div class="line">brew install hdf5</div>
</div><!-- fragment --><p> on MacOS.</p>
<p>(This is omitted from the user-facing docs because we don't have a stable version of TDMS with HDF5 yet.)</p>
<p>There are extra build options for developers:</p>
<div class="fragment"><div class="line">mkdir build; cd build</div>
<div class="line">cmake ../tdms \</div>
<div class="line"># -DMatlab_ROOT_DIR=/usr/local/MATLAB/R2019b/ \</div>
<div class="line"># -DFFTW_ROOT=/usr/local/fftw3/ \</div>
<div class="line"># -DCMAKE_INSTALL_PREFIX=$HOME/.local/ \</div>
<div class="line"># -DBUILD_TESTING=ON \</div>
<div class="line"># -DCODE_COVERAGE=ON \</div>
<div class="line"># -DCMAKE_BUILD_TYPE=Debug</div>
<div class="line">make install</div>
</div><!-- fragment --><p> You may need to help CMake find MATLAB/fftw/libhdf5 etc.</p>
<ul>
<li>By default, build testing is turned off. You can turn it on with <span class="tt">-DBUILD_TESTING=ON</span>.</li>
<li>By default, code coverage is disabled. You can enable it with <span class="tt">-DCODE_COVERAGE=ON</span>.<ul>
<li><a class="el" href="#coverage">Then follow some extra steps</a>.</li>
</ul>
</li>
<li>Also by default, debug printout is off. Turn on with <span class="tt">-DCMAKE_BUILD_TYPE=Debug</span> or manually at some specific place in the code with: <div class="fragment"><div class="line"><span class="preprocessor">#include &lt;spdlog/spdlog.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">spdlog::set_level(spdlog::level::debug);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">spdlog::debug(<span class="stringliteral">&quot;Send help&quot;</span>);</div>
</div><!-- fragment --></li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md19"></a>
Compiling on UCL's Myriad cluster</h2>
<details >
<summary >
Myriad instructions</summary>
<p></p>
<blockquote class="doxtable">
<p><b>Warning</b> These instructions are a bit experimental. Please use with care (and report anything that's wrong here)! </p>
</blockquote>
<p>If you want to test changes on UCL's <a href="https://www.rc.ucl.ac.uk/docs/Clusters/Myriad/">Myriad</a> (and/or don't have MATLAB on your pesonal machine) you can try these instructions. Firstly, you will probably want to <a href="https://stackoverflow.com/questions/12257968/">forward your ssh agent</a> for your github ssh key. To do this, you first need to run the following your <em>local</em> machine: </p><div class="fragment"><div class="line">ssh-add -L # check your ssh agent is running</div>
<div class="line">ssh-add /path/to/your/github/key/id_rsa</div>
<div class="line">ssh -o ForwardAgent=yes your_user@myriad.rc.ucl.ac.uk</div>
</div><!-- fragment --><p>And once you're on Myriad:</p>
<div class="fragment"><div class="line">git clone git@github.com:UCL/TDMS.git</div>
<div class="line"> </div>
<div class="line">module purge</div>
<div class="line">module load beta-modules</div>
<div class="line">module load gcc-libs/9.2.0 compilers/gnu/9.2.0 xorg-utils matlab/full/r2021a/9.10 fftw/3.3.6-pl2/gnu-4.9.2 cmake/3.21.1</div>
<div class="line">cd TDMS/tdms</div>
<div class="line">mkdir build; cd build</div>
<div class="line">cmake .. \</div>
<div class="line"># -DGIT_SSH=ON</div>
<div class="line">make install</div>
</div><!-- fragment --><p>If you get the following error (or similar) </p><div class="fragment"><div class="line">fatal: unable to access &#39;https://github.com/gabime/spdlog/&#39;: error setting certificate verify locations:</div>
<div class="line">CAfile: /etc/ssl/certs/ca-certificates.crt</div>
<div class="line">CApath: none</div>
</div><!-- fragment --><p> it's because the MATLAB module is interfering with the SSL certificates (and we clone over https by default). This issue is known and reported. As a workaround, we've added the build option <span class="tt">-DGIT_SSH=ON</span> to switch to <span class="tt">git clone</span> over ssh instead.</p>
<p></p>
</details>
<h1 class="doxsection"><a class="anchor" id="autotoc_md20"></a>
Navigating the algorithm code</h1>
<p>The C++ <span class="tt">main</span> function is in <span class="tt"><a class="el" href="main_8cpp.html" title="The main function. Launches TDMS.">main.cpp</a></span> however the main algorithm code is in the <span class="tt">execute()</span> method of the <span class="tt">SimulationManager</span> class, in <span class="tt">execute_simulation.cpp</span>.</p>
<p>Broadly speaking, the <span class="tt">main</span> function - and thus a call to (or execution of) <span class="tt">tdms</span> - can be broken down into the following steps:</p><ol type="1">
<li>Parse the input arguments</li>
<li>Prepare the simulation by creating an instance of <span class="tt">SimulationManager</span></li>
<li>Run the _main loop_. The <em>main loop</em> is meant to mean "the (implementation of) the time-stepping algorithm which TDMS uses", and is contained in the <span class="tt">execute()</span> method of the <span class="tt">SimulationManager</span> class.</li>
<li>Perform post-loop processing on the outputs, having completed the main loop (extraction of phasors, computing derived quantities, etc).</li>
<li>Write the outputs and tear-down memory.</li>
</ol>
<p>The <span class="tt">SimulationManager</span> class governs steps 2 through 5.</p>
<p>A flowchart that further breaks down the above steps can be viewed below. <img src="doc/assets/TDMS_flowchart.png" alt="" class="inline"/></p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md21"></a>
Code organisation of the TDMS algorithm</h1>
<p>An instance of <span class="tt">SimulationManager</span> essentially supports one <span class="tt">tdms</span> simulation, however functionality is divided across its member variables. These objects themselves group variables by functionality, purpose, and necessary scope. The list below provides a description of these objects (with parentheses denoting the member name in the <span class="tt">SimulationManager</span> instance):</p><ul>
<li><span class="tt">ObjectsFromInfile</span> (<span class="tt">inputs</span>): Handles conversion of any input arrays to native <span class="tt">C++</span> objects, and any variables that are derived directly from the input file supplied to <span class="tt">tdms</span> on the command line.</li>
<li><span class="tt">OutputMatrices</span> (<span class="tt">outputs</span>): Handles data storage for the outputs and the process of writing the output file.</li>
<li><span class="tt">PSTDVariables</span> (<span class="tt">PSTD</span>) and <span class="tt">FDTDBootstrapper</span> (<span class="tt">FDTD</span>): Handle variables that are only required for the pseudo-spectral and finite-difference solver methods, respectively.</li>
<li><span class="tt">LoopTimers</span> (<span class="tt">timers</span>): Controls timing (and logging execution times) of the main loop and subprocesses therein.</li>
</ul>
<p>The role of <span class="tt">SimulationManager</span> is to handle how these objects interact in the main loop.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md22"></a>
2. Initialisation</h2>
<p><span class="tt">SimulationManager</span> instances begin by initialising the <span class="tt">inputs</span> attribute. Based on this attribute, they set up <span class="tt">PSTD</span>/<span class="tt">FDTD</span> variables and prepare the <span class="tt">outputs</span> object for writing. Some members of the <span class="tt">outputs</span> objects are used as the buffer for the field and phasor data whilst the main loop is running, with the final state of this buffer being the output values. Other attributes of the <span class="tt">outputs</span> object that require information <em>from</em> the main loop are prepared (dimensions are determined, etc) at this stage but not set.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md23"></a>
3. Running the Main Loop</h2>
<p>Once initialised, the <span class="tt">execute()</span> method can be called. This will create an instance of <span class="tt">LoopVariables</span> that is scoped to this function; which in turn sets up the variables that are required in the main loop but not needed elsewhere. This avoids bloating the <span class="tt">execute()</span> method with a large number of variable declarations and setup, as well as simplifying tear-down at the end of the loop. <span class="tt">timers</span> track the speed of execution of the main loop, and report to the logging.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md24"></a>
4. Post-Processing</h2>
<p>Upon completing <span class="tt">execute()</span> successfully, the <span class="tt">post_loop_processing()</span> method of <span class="tt">SimulationManager</span> writes the data to the <span class="tt">outputs</span> attributes that were not used as buffers during the main loop.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md25"></a>
5. Write out and Tear Down</h2>
<p>From here, the <span class="tt">write_outputs()</span> method exports the data in <span class="tt">outputs</span> to the desired file.</p>
<p>At this point, the instance of <span class="tt">SimulationManager</span> can be allowed to go out of scope. In practice, <span class="tt">main()</span> terminates here and the destructor handles the tear-down of <span class="tt">MATLAB</span> memory blocks.</p>
<h1 class="doxsection"><a class="anchor" id="testing"></a>
Testing</h1>
<p>We have two <a href="https://en.wikipedia.org/wiki/Software_testing#Testing_levels">levels of tests</a>: unit tests, and full system tests.</p>
<h2 class="doxsection"><a class="anchor" id="unit-testing"></a>
Unit</h2>
<p>The unit tests use <a href="https://github.com/catchorg/Catch2/blob/devel/docs/Readme.md#top">catch2</a> macros. See <a href="https://github.com/UCL/TDMS/blob/main/tdms/tests/unit">tests/unit</a> for good examples in the actual test code.</p>
<p>To write a new test, as a rough sketch you need:</p>
<div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * @file test_file.cpp</span></div>
<div class="line"><span class="comment"> * @brief Short description of the tests.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#include &quot;things_to_be_tested.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;catch2/catch_test_macros.hpp&gt;</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * @brief Detailed description of the testing.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Maybe go into details about the test setup.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a class="code hl_function" href="test__argument__parser_8cpp.html#a4907558c7fcd2522c5394ecf8cd29558">TEST_CASE</a>(<span class="stringliteral">&quot;Write a meaningful test case name&quot;</span>) {</div>
<div class="line">    <span class="comment">// set up function calls or whatever</span></div>
<div class="line">    REQUIRE_THROW(&lt;something&gt;);</div>
<div class="line">    CHECK(&lt;something&gt;);</div>
<div class="line">}</div>
<div class="ttc" id="atest__argument__parser_8cpp_html_a4907558c7fcd2522c5394ecf8cd29558"><div class="ttname"><a href="test__argument__parser_8cpp.html#a4907558c7fcd2522c5394ecf8cd29558">TEST_CASE</a></div><div class="ttdeci">TEST_CASE(&quot;Test namespace&quot;)</div><div class="ttdoc">Test that the argument namespace recovers the input arguments provided.</div><div class="ttdef"><b>Definition</b> test_argument_parser.cpp:22</div></div>
</div><!-- fragment --><p> The doxygen-style comments will be included in this developer documentation.</p>
<p>To run the unit tests, <a class="el" href="#compiling">compile</a> with <span class="tt">-DBUILD_TESTING=ON</span>. Then run <span class="tt">ctest</span> from the build directory or execute the test executable <span class="tt">./tdms_tests</span>.</p>
<p>It's good practice, and reassuring for your pull-request reviewers, if new C++ functionality is covered by unit tests.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md26"></a>
Benchmark Scripts and Data Generation</h3>
<p>The <span class="tt">tdms/tests/unit/benchmark_scripts</span> directory contains scripts that produce input data for the unit tests, or that provide benchmarks for the units that are tested.</p>
<p>To generate the necessary test inputs; change into the <span class="tt">benchmark_scripts</span> directory and run,</p>
<div class="fragment"><div class="line">matlab -nosplash -nodesktop -nodisplay -r setup_unit_tests</div>
</div><!-- fragment --><details >
<summary >
More details about the data generation scripts and benchmarking</summary>
<p></p>
<p>The <span class="tt">C++</span> unit tests require the presence of a <span class="tt">.mat</span> or <span class="tt">.hdf5</span> file to read/write data from/to during testing. The locations of these files are coded into <span class="tt">tests/include/unit_test_utils.h</span>, but the files themselves are not committed to the repository - they can be created by running the <span class="tt">setup_unit_tests.m</span> and <span class="tt">create_hdf5_data.py</span> scripts. These scripts can then be updated to add/remove/edit the data available to the unit tests:</p><ul>
<li><span class="tt">create_hdf5_test_file.py</span> : Produces <span class="tt">hdf5_test_file.hdf5</span>; used when testing read/writing from <span class="tt">.hdf5</span> files.</li>
<li><span class="tt">create_structure_array.m</span> : Produces <span class="tt">structure_array.mat</span>; used when testing reading/writing MATLAB <span class="tt">struct</span> arrays.</li>
<li><span class="tt">create_class_data.m</span> : Produces <span class="tt">class_data.mat</span>; used when testing reading/writing <span class="tt">tdms</span> objects to/from <span class="tt">.mat</span> files.</li>
<li><span class="tt">create_bad_class_data.m</span> : Produces <span class="tt">bad_class_data.mat</span>; used for testing failure cases when reading/writing <span class="tt">tdms</span> objects to/from <span class="tt">.mat</span> files.</li>
</ul>
<p>The <span class="tt">benchmark_</span> scripts perform band-limited interpolation (BLi) using <span class="tt">MATLAB</span>'s <span class="tt">interp</span> function. <span class="tt">TDMS</span>'s interpolation schemes are based off this <span class="tt">MATLAB</span> function (specficially, in the coefficients the scheme uses to interpolate), and are thus used to benchmark the accuracy of the scheme.</p>
<p></p>
</details>
<h2 class="doxsection"><a class="anchor" id="coverage"></a>
Test coverage</h2>
<p>If you want to check the coverage of the unit tests, then build with <span class="tt">-DCODE_COVERAGE=ON</span>. Then when you run <span class="tt">ctest</span> or the <span class="tt">tdms_tests</span> executable, <a href="https://gcc.gnu.org/onlinedocs/gcc/Gcov-Data-Files.html">GCDA coverage files</a> are generated. They are not really for humans to parse but can be summarised with other tools. In our build system we use <a href="https://github.com/linux-test-project/lcov"><span class="tt">lcov</span></a>, a frontend for <span class="tt">gcov</span> reports. If you don't have <span class="tt">lcov</span>, you can install it with aptitude or homebrew (<span class="tt">sudo apt install lcov</span> or <span class="tt">brew install lcov</span>).</p>
<p>To get a coverage report in the terminal: execute the unit tests and then confirm you generated .gcda files... </p><div class="fragment"><div class="line">./tdms_tests</div>
<div class="line">find . --name &quot;*.gcda&quot;</div>
</div><!-- fragment --><p> they're probably somewhere like <span class="tt">build/CMakeFiles/tdms.dir/src</span>.</p>
<p>Then generate the coverage report with </p><div class="fragment"><div class="line">lcov --capture --directory ./CMakeFiles/tdms_tests.dir/src --output-file coverage.info</div>
<div class="line">lcov --list coverage.info</div>
</div><!-- fragment --><p> You'll notice it also counts the dependencies. You can filter these (<span class="tt">lcov --remove</span>) if you don't want them to appear in the statistics: </p><div class="fragment"><div class="line">lcov --remove coverage.info &#39;/usr/*&#39; --output-file coverage.info</div>
<div class="line">lcov --remove coverage.info &#39;*/_deps/*&#39; --output-file coverage.info</div>
</div><!-- fragment --><p>But you don't need to worry about this too much. When you open a pull-request, codecov will report. And you can browse the <a href="https://codecov.io/gh/UCL/TDMS">codecov TDMS pages online</a>.</p>
<h2 class="doxsection"><a class="anchor" id="matlab-unit-tests"></a>
MATLAB Units</h2>
<p>To run the unit tests, go to the <span class="tt">tdms/tests/matlab</span> directory and use the command:</p>
<div class="fragment"><div class="line">matlab -batch run_tests</div>
</div><!-- fragment --><p>In the <span class="tt">utils</span> folder, you'll find small MATLAB functions to edit the <span class="tt">data/pstd_input_file{2,3}D.m</span> files during the testing phase.</p>
<p>The <span class="tt">iteratefdtd_matrix</span> function has different ways to generate source terms from an input file. However, some combinations of variables provided can be incompatible, resulting in errors or contradictory information. The unit test <span class="tt">test_iteratefdtd_matrix_source_combinations</span> goes through each possible combination of source-related inputs, checking for errors or valid input combinations. The combinations and expected results are listed in the table below.</p>
<dl class="section note"><dt>Note</dt><dd><span class="tt">TD-field</span> is also known as <span class="tt">exi/eyi</span> in some docstrings.</dd>
<dd>
<span class="tt">usecd</span> was the legacy name for the variable that controlled which solver method to use in the timestepping algorithm. Previous convention was that <span class="tt">usecd = 1</span> (or not present) resulted in the use of FDTD. This has since been superseded by the <span class="tt">use_pstd</span> flag which is <span class="tt">true</span> when PSTD is to be used, and FDTD will be used otherwise (such as when this flag is not present or set explicitly to <span class="tt">false</span>).</dd></dl>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">TD-field  </th><th class="markdownTableHeadCenter">Using FDTD  </th><th class="markdownTableHeadCenter">compactsource  </th><th class="markdownTableHeadCenter">efname  </th><th class="markdownTableHeadCenter">hfname  </th><th class="markdownTableHeadCenter">Raises error?  </th><th class="markdownTableHeadCenter">Error info  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot specify hfname if compact source  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot specify hfname if compact source  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">If not compact source, both efname and hfname must be specified  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">If not compact source, both efname and hfname must be specified  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot specify hfname if compact source  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot specify hfname if compact source  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot use FDTD &amp; not compactsource  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot use FDTD &amp; not compactsource  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot use FDTD &amp; not compactsource  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot use FDTD &amp; not compactsource  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot specify hfname if compact source  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot specify hfname if compact source  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Must specify efname if compact source and TD-field not specified  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">If not TD-field and using FDTD, must specify both efname and hfname  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">If not TD-field and using FDTD, must specify both efname and hfname  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">If not TD-field and using FDTD, must specify both efname and hfname  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot specify hfname if compact source  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot specify hfname if compact source  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Must specify efname if compact source and TD-field not specified  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot use FDTD &amp; not compactsource  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot use FDTD &amp; not compactsource  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot use FDTD &amp; not compactsource  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">0  </td><td class="markdownTableBodyCenter">1  </td><td class="markdownTableBodyCenter">Cannot use FDTD &amp; not compactsource  </td></tr>
</table>
<h2 class="doxsection"><a class="anchor" id="system-tests"></a>
System</h2>
<p>The full system tests are written in Python 3, and call the <span class="tt">tdms</span> executable for known inputs and compare to expected outputs. We use <a href="https://docs.pytest.org">pytest</a> and our example data is provided as zip files on <a href="https://zenodo.org/record/7899298">zenodo</a>.</p>
<dl class="section warning"><dt>Warning</dt><dd>Important to note that most of these tests are downsampled and/or not physically meaningful. They simply test for regressions of the code. If you are interested in examples that do have some physical meaning take a look at <span class="tt">arc03</span> and <span class="tt">arc12</span>.</dd></dl>
<p>There are a few <a href="https://github.com/UCL/TDMS/blob/main/tdms/tests/requirements.txt">python packages you will need</a> before you are able to run the tests, which can be installed by executing: </p><div class="fragment"><div class="line">python -m pip install -r tdms/tests/requirements.txt</div>
</div><!-- fragment --><p> if you don't already have them. You'll then need to <a class="el" href="#compiling">compile</a> <span class="tt">tdms</span> with <span class="tt">-DBUILD_TESTING=ON</span>. Once compiled, the system tests can be run by invoking <span class="tt">pytest</span> and pointing it to the <span class="tt">tdms/tests/system</span> directory. For example, from the build directory: </p><div class="fragment"><div class="line">$ pwd</div>
<div class="line">/path/to/repository/TDMS/tdms/build</div>
<div class="line">$ pytest ../tests/system/</div>
</div><!-- fragment --><p> The <a href="https://github.com/UCL/TDMS/blob/main/tdms/tests/system/test_system.py"><span class="tt">test_system.py</span></a> script runs each system test in sequence.</p>
<p>When you run the tests for the first time, the test data is downloaded to <span class="tt">tdms/tests/system/data</span> (and will be <a href="https://github.com/UCL/TDMS/blob/main/.gitignore">ignored by git</a>). Subsequent runs of the tests will not re-download unless you manually delete the zip file(s).</p>
<p>The test data contains reference input files which contain arrays for the incident electric field, the computational grid, and so on (needed by the simulation). The files have been generated by a trusted version of the relevant MATLAB scripts. The data also contains reference <em>output</em> files which have been generated by a trusted version of TDMS - the system tests check output against reference outputs. I.e. regression testing: that new changes have preserved the functionality of TDMS.</p>
<p>The system tests for <span class="tt">tdms</span> are configured with yaml files in the <span class="tt">data/input_generation/</span> directory. They are named <span class="tt">config_XX.yaml</span> where <span class="tt">XX</span> matches the ID of the system test, which themselves are named <span class="tt">arc_XX</span> by historical convention. These config files define a number of variables, parameters, and filenames that will be required when running the system tests - for a detailed breakdown of their syntax, see the annotated <span class="tt">config_01.yaml</span> file. This should also match the <span class="tt">test_id</span> field in the configuration file itself. The <em>reference outputs</em> or <em>reference data</em> are a collection of <span class="tt">.mat</span> files, produced from the <em>reference inputs</em> by a trusted version of the <span class="tt">tdms</span> executable. We test for regression using these reference files.</p>
<p>A given system test typically has two calls to the <span class="tt">tdms</span> executable; one for when there is no scattering object present, and one for when there is some obstacle. More than two runs in a test might be due to the use of band-limited interpolation over cubic interpolation. Each call to the executable has a reference input and reference output. In the scripts, a given execution is called by <span class="tt">tests.utils.run_tdms</span> which wraps a <a href="https://docs.python.org/3/library/subprocess.html#subprocess.Popen">subprocess.Popen</a>.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md27"></a>
Workflow of a System Test</h3>
<p>The workflow of a particular system test <span class="tt">arc_XX</span> is:</p><ul>
<li>Locally generate the reference inputs using functionality in <span class="tt">data/input_generation/generate_test_data.py</span>.<ul>
<li><span class="tt">arc_XX</span> fails if its reference input cannot be successfully generated.</li>
</ul>
</li>
<li>Fetch the reference outputs from <a href="https://zenodo.org/record/7440616/files">Zenodo</a>.</li>
<li>For each run, named <span class="tt">run_id</span> in <span class="tt">arc_XX</span>:<ul>
<li>Execute the call to <span class="tt">tdms</span> corresponding to <span class="tt">run_id</span>.</li>
<li>Compare the output of each run to the corresponding reference data.</li>
<li><span class="tt">run_id</span> fails if the output produced differs significantly from the reference data.</li>
<li>Outputs produced by <span class="tt">run_id</span> are cleaned up.</li>
</ul>
</li>
<li><span class="tt">arc_XX</span> fails if any one of its runs fail. Failed runs are reported by name.</li>
<li>Reference inputs are cleaned up.</li>
<li><span class="tt">arc_XX</span> passes if this step is reached successfully.</li>
</ul>
<p>Due to <a href="https://github.com/matlab-actions/setup-matlab/issues/13">licensing issues regarding running <span class="tt">MATLAB</span> on GitHub runners</a>, we cannot use <span class="tt">matlabengine</span> to regenerate the reference input data during CI. (Although we are currently thinking of removing the <span class="tt">MATLAB</span> dependency which will then enable us to resolve this issue). The work-in-progress <span class="tt">test_regen.py</span> workflow can still be run locally through <span class="tt">pytest</span>, however in addition to <span class="tt">requirements.txt</span> you will also need to <a href="https://uk.mathworks.com/help/matlab/matlab_external/install-the-matlab-engine-for-python.html">install <span class="tt">matlabengine</span></a>. See the <a href="https://uk.mathworks.com/help/matlab/matlab_external/install-the-matlab-engine-for-python.html">MathWorks page</a> link for detailed requirements. You will need (at least) <span class="tt">Python &gt;= 3.8</span> and a licensed version of <span class="tt">MATLAB</span>.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md28"></a>
Generating Input Data for the System Tests</h2>
<p>The system tests rely on <span class="tt">.mat</span> input files that are generated through a series of MATLAB function calls and scripts. This directory contains the functionality to automatically (re)generate this input data, which serves two purposes:</p><ul>
<li>The <span class="tt">.mat</span> <em>input</em> files do not need to be uploaded and fetched from Zenodo each time the system tests are run. They can be generated locally instead.<ul>
<li>Note that the reference output files corresponding to these inputs still need to be downloaded from Zenodo.</li>
</ul>
</li>
<li>We track changes to the way we handle inputs to <span class="tt">tdms</span>, and the system tests. Ensuring we test against unexpected behaviour due to input changes.</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md29"></a>
(Re)generation of the Data</h3>
<p>(Re)generating the input data for a particular test case, <span class="tt">arc_XX</span>, is a three-step process:</p><ol type="1">
<li>Determine variables, filenames, and the particular setup of <span class="tt">arc_XX</span>. This information is stored in the corresponding <span class="tt">config_XX.yaml</span> file. For example, is an illumination file required? What are the spatial obstacles? What is the solver method?</li>
</ol>
<ol type="1">
<li>Call the <span class="tt">run_bscan.m</span> function (and sub-functions in <span class="tt">./matlab</span>) using the information in <span class="tt">config_XX.yaml</span> to produce the <span class="tt">.mat</span> input files. Each test case requires an input file (<span class="tt">input_file_XX.m</span>) which defines test-specific variables (domain size, number of period cells, material properties, etc) which are too complex to specify in a <span class="tt">.yaml</span> file.</li>
</ol>
<ol type="1">
<li>Clean up the auxiliary <span class="tt">.mat</span> files that are generated by this process. In particular, any <span class="tt">gridfiles.mat</span>, illumination files, or other <span class="tt">.mat</span> files that are temporarily created when generating the input <span class="tt">.mat</span> file.</li>
</ol>
<h3 class="doxsection"><a class="anchor" id="autotoc_md30"></a>
Contents of the <span class="tt">data/input_generation</span> Directory (and subdirectories)</h3>
<p>The <span class="tt">run_bscan</span> function is inside the <span class="tt">bscan/</span> directory.</p>
<p>The <span class="tt">matlab/</span> directory contains functions that <span class="tt">run_bscan</span> will need to call on during the creation of the input data. This in particular includes the <span class="tt">iteratefdtd_matrix</span> function, which does the majority of the work in setting up gridfiles, illumination files, and the <span class="tt">.mat</span> inputs themselves.</p>
<p>The <span class="tt">generate_test_input.py</span> file contains <span class="tt">.py</span> files that the system tests can invoke to regenerate the input data. Since the system test framework uses <span class="tt">pytest</span>, but the data generation requires <span class="tt">MATLAB</span> (for now), we use <span class="tt">Python</span> to read in and process the information that each test requires, and then call <span class="tt">run_bscan</span> with the appropriate commands from within Python.</p>
<p>The <span class="tt">regenerate_all.py</span> file will work through all of the <span class="tt">config_XX.yaml</span> files in the directory and regenerate the input <span class="tt">.mat</span> data corresponding to each.</p>
<p>The remaining <span class="tt">config_XX.yaml</span> and <span class="tt">input_file_XX.m</span> files are as mentioned in the previous section. These contain the information about each test that Python and <span class="tt">run_bscan</span> will need to regenerate the input files. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
