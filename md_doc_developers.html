<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TDMS: Developer documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">TDMS
   </div>
   <div id="projectbrief">Time Domain Maxwell Solver</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_doc_developers.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Developer documentation </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Welcome to the developer documentation for TDMS, the Time Domain Maxwell Solver. These pages contain the C++ API documentation as well as some other useful information for developers.</p>
<h1><a class="anchor" id="autotoc_md11"></a>
Developers' introduction to TDMS</h1>
<p>The physics background and numerical methods used by TDMS are described in <a href="https://github.com/UCL/TDMS/blob/gh-doc/masterdoc.pdf">this pdf document</a> (the source is in <a href="https://github.com/UCL/TDMS/blob/main/doc/latex">doc/latex</a>). In terms of the code, <code>tdms</code> is a C++ binary that can be installed in the <code>PATH</code>. We build with <a href="https://cmake.org/">CMake</a> to be moderately platform-independent. We run continuous integration builds and tests on Windows, Ubuntu, and MacOS.</p>
<h1><a class="anchor" id="autotoc_md12"></a>
Dependencies</h1>
<p>We depend on ...</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/OpenMP">OpenMP</a> for parallelization.</li>
<li><a href="https://www.fftw.org/">fftw</a> to calculate numerical derivatives (<a class="el" href="numerical__derivative_8h.html" title="Functions to calculate the numerical derivatives.">numerical_derivative.h</a>)</li>
<li><a href="https://github.com/gabime/spdlog">spdlog</a> for logging (this is installed automatically by a CMake <a href="https://cmake.org/cmake/help/latest/module/FetchContent.html">FetchContent</a> if not found).</li>
<li><a href="https://www.mathworks.com/products/matlab.html">MATLAB</a> since we read in and write out MATLAB format files. We are actually thinking of removing this as a strict dependency (<a href="https://github.com/UCL/TDMS/issues/70">#70</a>).</li>
</ul>
<h1><a class="anchor" id="code-style-and-doxygen"></a>
Code style and other admin</h1>
<p>We try to stick to <a href="https://google.github.io/styleguide/cppguide.html">Google style C++</a> wherever practicable. There is one exception: we prefer <code>#pragma once</code> at the top of each header (because it's one line rather than three and is almost the standard anyway).</p>
<p>Please keep doxygen-style comments in the <b>headers</b>. </p><div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * Add two numbers together</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * @param a: real number</span></div>
<div class="line"><span class="comment"> * @param b: real number</span></div>
<div class="line"><span class="comment"> * @return sum of a and b</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">double</span> add(<span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b);</div>
</div><!-- fragment --><p> And please document the header itself with at least: </p><div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * @file filename.h</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Describe the functions/classes in here.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor"> #pragma once</span></div>
</div><!-- fragment --><p> You can quickly check the documentation for your changes look correct with: </p><div class="fragment"><div class="line">doxygen doc/Doxygen</div>
<div class="line">firefox html/index.html # or your web browser of choice</div>
</div><!-- fragment --><p> You should be able to find and read what you've changed. Don't worry about doxygen for the source files (although obviously please do write helpful comments there). We <em>have</em> been putting doxygen comments in the <a class="el" href="md_doc_developers.html#unit-testing">unit-test</a> source files wherever sensible.</p>
<h2><a class="anchor" id="pre-commit"></a>
Linters and automatic code style</h2>
<p>For C++ we've found <a href="https://clang.llvm.org/docs/ClangFormat.html">ClangFormat</a> works well. For Python code (e.g. in the <a class="el" href="md_doc_developers.html#system-tests">system tests</a>) we use <a href="https://black.readthedocs.io/en/stable/">black</a>.</p>
<p>To apply automatic code styling to staged changes in git we recommend <a href="https://pre-commit.com/"><code>pre-commit</code></a>. If you don't have it already: </p><div class="fragment"><div class="line">python -m pip install pre-commit</div>
</div><!-- fragment --><p>Then from the root repository directory you can add the pre-commit hooks with </p><div class="fragment"><div class="line">ls .git/hooks</div>
<div class="line">pre-commit install</div>
<div class="line">ls .git/hooks</div>
</div><!-- fragment --><h1><a class="anchor" id="compiling"></a>
Compiling and debugging</h1>
<p>Once you've checked the code out, compile with: </p><div class="fragment"><div class="line">mkdir build; cd build</div>
<div class="line">cmake ../tdms \</div>
<div class="line"># -DMatlab_ROOT_DIR=/usr/local/MATLAB/R2019b/ \</div>
<div class="line"># -DFFTW_ROOT=/usr/local/fftw3/ \</div>
<div class="line"># -DCMAKE_INSTALL_PREFIX=$HOME/.local/ \</div>
<div class="line"># -DBUILD_TESTING=ON \</div>
<div class="line"># -DCODE_COVERAGE=ON \</div>
<div class="line"># -DCMAKE_BUILD_TYPE=Debug</div>
<div class="line">make install</div>
</div><!-- fragment --><p> You may need to help CMake find MATLAB/fftw etc.</p>
<ul>
<li>By default, build testing is turned off. You can turn it on with <code>-DBUILD_TESTING=ON</code>.</li>
<li>By default, code coverage is disabled. You can enable it with <code>-DCODE_COVERAGE=ON</code>.<ul>
<li><a class="el" href="md_doc_developers.html#coverage">Then follow some extra steps</a>.</li>
</ul>
</li>
<li>Also by default, debug printout is off. Turn on with <code>-DCMAKE_BUILD_TYPE=Debug</code> or manually at some specific place in the code with: <div class="fragment"><div class="line"><span class="preprocessor">#include &lt;spdlog/spdlog.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">spdlog::set_level(spdlog::level::debug);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">spdlog::debug(<span class="stringliteral">&quot;Send help&quot;</span>);</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md13"></a>
Compiling on UCL's Myriad cluster</h2>
<details >
<summary >
Myriad instructions</summary>
<p></p>
<blockquote class="doxtable">
<p>&zwj;<b>Warning</b> These instructions are a bit experimental. Please use with care (and report anything that's wrong here)! </p>
</blockquote>
<p>If you want to test changes on UCL's <a href="https://www.rc.ucl.ac.uk/docs/Clusters/Myriad/">Myriad</a> (and/or don't have MATLAB on your pesonal machine) you can try these instructions. Firstly, you will probably want to <a href="https://stackoverflow.com/questions/12257968/">forward your ssh agent</a> for your github ssh key. To do this, you first need to run the following your <em>local</em> machine: </p><div class="fragment"><div class="line">ssh-add -L # check your ssh agent is running</div>
<div class="line">ssh-add /path/to/your/github/key/id_rsa</div>
<div class="line">ssh -o ForwardAgent=yes your_user@myriad.rc.ucl.ac.uk</div>
</div><!-- fragment --><p>And once you're on Myriad:</p>
<div class="fragment"><div class="line">git clone git@github.com:UCL/TDMS.git</div>
<div class="line"> </div>
<div class="line">module purge</div>
<div class="line">module load beta-modules</div>
<div class="line">module load gcc-libs/9.2.0 compilers/gnu/9.2.0 xorg-utils matlab/full/r2021a/9.10 fftw/3.3.6-pl2/gnu-4.9.2 cmake/3.21.1</div>
<div class="line">cd TDMS/tdms</div>
<div class="line">mkdir build; cd build</div>
<div class="line">cmake .. \</div>
<div class="line"># -DGIT_SSH=ON</div>
<div class="line">make install</div>
</div><!-- fragment --><p>If you get the following error (or similar) </p><div class="fragment"><div class="line">fatal: unable to access &#39;https://github.com/gabime/spdlog/&#39;: error setting certificate verify locations:</div>
<div class="line">CAfile: /etc/ssl/certs/ca-certificates.crt</div>
<div class="line">CApath: none</div>
</div><!-- fragment --><p> it's because the MATLAB module is interfering with the SSL certificates (and we clone over https by default). This issue is known and reported. As a workaround, we've added the build option <code>-DGIT_SSH=ON</code> to switch to <code>git clone</code> over ssh instead.</p>
<p></p>
</details>
<h1><a class="anchor" id="autotoc_md14"></a>
Where's the main?</h1>
<p>The C++ <code>main</code> function is in <code><a class="el" href="main_8cpp.html" title="The main function. Launches TDMS.">main.cpp</a></code> however the main algorithm code is in the <code>execute()</code> method of the <code>SimulationManager</code> class, in <code>execute_simulation.cpp</code>.</p>
<p>Broadly speaking, the <code>main</code> function - and thus a call to (or execution of) <code>tdms</code> - can be broken down into the following steps:</p><ol type="1">
<li>Parse the input arguments</li>
<li>Prepare the simulation by creating an instance of <code>SimulationManager</code></li>
<li>Run the _main loop_. The <em>main loop</em> is meant to mean "the (implementation of) the time-stepping algorithm which TDMS uses", and is contained in the <code>execute()</code> method of the <code>SimulationManager</code> class.</li>
<li>Perform post-loop processing on the outputs, having completed the main loop (extraction of phasors, computing derived quantities, etc).</li>
<li>Write the outputs and tear-down memory.</li>
</ol>
<p>The <code>SimulationManager</code> class governs steps 2 through 5.</p>
<h1><a class="anchor" id="autotoc_md15"></a>
Code organisation of the TDMS algorithm</h1>
<p>An instance of <code>SimulationManager</code> essentially supports one <code>tdms</code> simulation, however functionality is divided across its member variables. These objects themselves group variables by functionality, purpose, and necessary scope. The list below provides a description of these objects (with parentheses denoting the member name in the <code>SimulationManager</code> instance):</p><ul>
<li><code>ObjectsFromInfile</code> (<code>inputs</code>): Handles conversion of any input arrays to native <code>C++</code> objects, and any variables that are derived directly from the input file supplied to <code>tdms</code> on the command line.</li>
<li><code>OutputMatrices</code> (<code>outputs</code>): Handles data storage for the outputs and the process of writing the output file.</li>
<li><code>PSTDVariables</code> (<code>PSTD</code>) and <code>FDTDBootstrapper</code> (<code>FDTD</code>): Handle variables that are only required for the pseudo-spectral and finite-difference solver methods, respectively.</li>
<li><code>LoopTimers</code> (<code>timers</code>): Controls timing (and logging execution times) of the main loop and subprocesses therein.</li>
</ul>
<p>The role of <code>SimulationManager</code> is to handle how these objects interact in the main loop.</p>
<h2><a class="anchor" id="autotoc_md16"></a>
2. Initialisation</h2>
<p><code>SimulationManager</code> instances begin by initialising the <code>inputs</code> attribute. Based on this attribute, they set up <code>PSTD</code>/<code>FDTD</code> variables and prepare the <code>outputs</code> object for writing. Some members of the <code>outputs</code> objects are used as the buffer for the field and phasor data whilst the main loop is running, with the final state of this buffer being the output values. Other attributes of the <code>outputs</code> object that require information <em>from</em> the main loop are prepared (dimensions are determined, etc) at this stage but not set.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
3. Running the Main Loop</h2>
<p>Once initialised, the <code>execute()</code> method can be called. This will create an instance of <code>LoopVariables</code> that is scoped to this function; which in turn sets up the variables that are required in the main loop but not needed elsewhere. This avoids bloating the <code>execute()</code> method with a large number of variable declarations and setup, as well as simplifying tear-down at the end of the loop. <code>timers</code> track the speed of execution of the main loop, and report to the logging.</p>
<h2><a class="anchor" id="autotoc_md18"></a>
4. Post-Processing</h2>
<p>Upon completing <code>execute()</code> successfully, the <code>post_loop_processing()</code> method of <code>SimulationManager</code> writes the data to the <code>outputs</code> attributes that were not used as buffers during the main loop.</p>
<h2><a class="anchor" id="autotoc_md19"></a>
5. Write out and Tear Down</h2>
<p>From here, the <code>write_outputs()</code> method exports the data in <code>outputs</code> to the desired file.</p>
<p>At this point, the instance of <code>SimulationManager</code> can be allowed to go out of scope. In practice, <code>main()</code> terminates here and the destructor handles the tear-down of <code>MATLAB</code> memory blocks.</p>
<h1><a class="anchor" id="testing"></a>
Testing</h1>
<p>We have two <a href="https://en.wikipedia.org/wiki/Software_testing#Testing_levels">levels of tests</a>: unit tests, and full system tests.</p>
<h2><a class="anchor" id="unit-testing"></a>
Unit</h2>
<p>The unit tests use <a href="https://github.com/catchorg/Catch2/blob/devel/docs/Readme.md#top">catch2</a> macros. See <a href="https://github.com/UCL/TDMS/blob/main/tdms/tests/unit">tests/unit</a> for good examples in the actual test code.</p>
<p>To write a new test, as a rough sketch you need:</p>
<div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * @file test_file.cpp</span></div>
<div class="line"><span class="comment"> * @brief Short description of the tests.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#include &quot;things_to_be_tested.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;catch2/catch_test_macros.hpp&gt;</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * @brief Detailed description of the testing.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Maybe go into details about the test setup.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a class="code hl_function" href="test__argument__parser_8cpp.html#a45fe347857b250e8d575563026c40435">TEST_CASE</a>(<span class="stringliteral">&quot;Write a meaningful test case name&quot;</span>) {</div>
<div class="line">    <span class="comment">// set up function calls or whatever</span></div>
<div class="line">    REQUIRE_THROW(&lt;something&gt;);</div>
<div class="line">    CHECK(&lt;something&gt;);</div>
<div class="line">}</div>
<div class="ttc" id="atest__argument__parser_8cpp_html_a45fe347857b250e8d575563026c40435"><div class="ttname"><a href="test__argument__parser_8cpp.html#a45fe347857b250e8d575563026c40435">TEST_CASE</a></div><div class="ttdeci">TEST_CASE(&quot;Test parsing help&quot;)</div><div class="ttdoc">Test that the argument namespace recovers the input arguments provided.</div><div class="ttdef"><b>Definition:</b> test_argument_parser.cpp:22</div></div>
</div><!-- fragment --><p> The doxygen-style comments will be included in this developer documentation.</p>
<p>To run the unit tests, <a class="el" href="md_doc_developers.html#compiling">compile</a> with <code>-DBUILD_TESTING=ON</code>. Then run <code>ctest</code> from the build directory or execute the test executable <code>./tdms_tests</code>.</p>
<p>It's good practice, and reassuring for your pull-request reviewers, if new C++ functionality is at covered by unit tests.</p>
<h2><a class="anchor" id="coverage"></a>
Test coverage</h2>
<p>If you want to check the coverage of the unit tests, then build with <code>-DCODE_COVERAGE=ON</code>. Then when you run <code>ctest</code> or the <code>tdms_tests</code> executable, <a href="https://gcc.gnu.org/onlinedocs/gcc/Gcov-Data-Files.html">GCDA coverage files</a> are generated. They are not really for humans to parse but can be summarised with other tools. In our build system we use <a href="https://github.com/linux-test-project/lcov"><code>lcov</code></a>, a frontend for <code>gcov</code> reports. If you don't have <code>lcov</code>, you can install it with aptitude or homebrew (<code>sudo apt install lcov</code> or <code>brew install lcov</code>).</p>
<p>To get a coverage report in the terminal: execute the unit tests and then confirm you generated .gcda files... </p><div class="fragment"><div class="line">./tdms_tests</div>
<div class="line">find . --name &quot;*.gcda&quot;</div>
</div><!-- fragment --><p> they're probably somewhere like <code>build/CMakeFiles/tdms.dir/src</code>.</p>
<p>Then generate the coverage report with </p><div class="fragment"><div class="line">lcov --capture --directory ./CMakeFiles/tdms_tests.dir/src --output-file coverage.info</div>
<div class="line">lcov --list coverage.info</div>
</div><!-- fragment --><p> You'll notice it also counts the dependencies. You can filter these (<code>lcov --remove</code>) if you don't want them to appear in the statistics: </p><div class="fragment"><div class="line">lcov --remove coverage.info &#39;/usr/*&#39; --output-file coverage.info</div>
<div class="line">lcov --remove coverage.info &#39;*/_deps/*&#39; --output-file coverage.info</div>
</div><!-- fragment --><p>But you don't need to worry about this too much. When you open a pull-request, codecov will report. And you can browse the <a href="https://codecov.io/gh/UCL/TDMS">codecov TDMS pages online</a>.</p>
<h2><a class="anchor" id="system-tests"></a>
System</h2>
<p>The full system tests are written in Python 3, and call the <code>tdms</code> executable for known inputs and compare to expected outputs. We use <a href="https://docs.pytest.org">pytest</a> and our example data is provided as zip files on <a href="https://zenodo.org/">zenodo</a>.</p>
<p>There are a few <a href="https://github.com/UCL/TDMS/blob/main/tdms/tests/requirements.txt">python packages you will need</a> before you are able to run the tests, which can be installed by executing: </p><div class="fragment"><div class="line">python -m pip install -r tdms/tests/requirements.txt</div>
</div><!-- fragment --><p> if you don't already have them. You'll then need to <a class="el" href="md_doc_developers.html#compiling">compile</a> <code>tdms</code> with <code>-DBUILD_TESTING=ON</code>. Once compiled, the system tests can be run by invoking <code>pytest</code> and pointing it to the <code>tdms/tests/system</code> directory. For example, from the build directory: </p><div class="fragment"><div class="line">$ pwd</div>
<div class="line">/path/to/repository/TDMS/tdms/build</div>
<div class="line">$ pytest ../tests/system/</div>
</div><!-- fragment --><p> The <a href="https://github.com/UCL/TDMS/blob/main/tdms/tests/system/test_system.py"><code>test_system.py</code></a> script runs each system test in sequence.</p>
<p>**<a href="https://github.com/UCL/TDMS/blob/main/tdms/tests/system/test_regen.py"><code>test_regen.py</code></a> and <a href="https://github.com/UCL/TDMS/blob/main/tdms/tests/system/tdms_testing_class.py.py"><code>tdms_testing_class.py</code></a> will replace <code>test_system.py</code> and <code>read_config.py</code> when the <a href="https://github.com/UCL/TDMS/issues/70">input overhaul</a> is complete.**</p>
<p>When you run the tests for the first time, test data is downloaded to <code>tdms/tests/system/data</code> (and will be <a href="https://github.com/UCL/TDMS/blob/main/.gitignore">ignored by git</a>). These reference input files contain arrays for: the incident electric field, the computational grid, etc. which are needed by the simulation, and have been generated by a trusted version of the relevant MATLAB scripts. Subsequent runs of the tests will not re-download unless you manually delete the zip file(s).</p>
<p>The system tests for <code>tdms</code> are configured with yaml files in the <code>data/input_generation/</code> directory. They are named <code>config_XX.yaml</code> where <code>XX</code> matches the ID of the system test, which themselves are named <code>arc_XX</code> by historical convention. This should also match the <code>test_id</code> field in the configuration file itself. The <em>reference outputs</em> or <em>reference data</em> are a collection of <code>.mat</code> files, produced from the <em>reference inputs</em> by a trusted version of the <code>tdms</code> executable. We test for regression using these reference files.</p>
<p>A given system test typically has two calls to the <code>tdms</code> executable; one for when there is no scattering object present, and one for when there is some obstacle. More than two runs in a test might be due to the use of band-limited interpolation over cubic interpolation. Each call to the executable has a reference input and reference output. In the scripts, a given execution is called by <code>tests.utils.run_tdms</code> which wraps a <a href="https://docs.python.org/3/library/subprocess.html#subprocess.Popen">subprocess.Popen</a>.</p>
<h3><a class="anchor" id="autotoc_md20"></a>
Workflow of a System Test</h3>
<p>The workflow of a particular system test <code>arc_XX</code> is:</p><ul>
<li>Locally generate the reference inputs using <code>data/input_generation/WHATISTHESCRIPTNAME.py</code>.<ul>
<li><code>arc_XX</code> fails if its reference input cannot be successfully generated. This indicates a failure in the scripts and/or functions in the <code>data/input_generation/{bscan,matlab}</code> directories.</li>
</ul>
</li>
<li>Fetch the reference outputs from <a href="https://zenodo.org/record/7440616/files">Zenodo</a>.</li>
<li>For each run, named <code>run_id</code> in <code>arc_XX</code>:<ul>
<li>Execute the call to <code>tdms</code> corresponding to <code>run_id</code>.</li>
<li>Compare the output of each run to the corresponding reference data.</li>
<li><code>run_id</code> fails if the output produced differs significantly from the reference data.</li>
<li>Outputs produced by <code>run_id</code> are cleaned up.</li>
</ul>
</li>
<li><code>arc_XX</code> fails if any one of its runs fail. Failed runs are reported by name.</li>
<li>Reference inputs are cleaned up.</li>
<li><code>arc_XX</code> passes if this step is reached successfully.</li>
</ul>
<p>Due to <a href="https://github.com/matlab-actions/setup-matlab/issues/13">licensing issues regarding running <code>MATLAB</code> on GitHub runners</a>, we cannot use <code>matlabengine</code> to regenerate the reference input data during CI. (Although we are currently thinking of removing the <code>MATLAB</code> dependency which will then enable us to resolve this issue). The work-in-progress <code>test_regen.py</code> workflow can still be run locally through <code>pytest</code>, however in addition to <code>requirements.txt</code> you will also need to <a href="https://uk.mathworks.com/help/matlab/matlab_external/install-the-matlab-engine-for-python.html">install <code>matlabengine</code></a>. See the <a href="https://uk.mathworks.com/help/matlab/matlab_external/install-the-matlab-engine-for-python.html">MathWorks page</a> link for detailed requirements. You will need (at least) <code>Python &gt;= 3.8</code> and a licensed version of <code>MATLAB</code>.</p>
<h2><a class="anchor" id="autotoc_md21"></a>
Generating Input Data for the System Tests</h2>
<p>The system tests rely on <code>.mat</code> input files that are generated through a series of MATLAB function calls and scripts. This directory contains the functionality to automatically (re)generate this input data, which serves two purposes:</p><ul>
<li>The <code>.mat</code> <em>input</em> files do not need to be uploaded and fetched from Zenodo each time the system tests are run. They can be generated locally instead.<ul>
<li>Note that the reference output files corresponding to these inputs still need to be downloaded from Zenodo.</li>
</ul>
</li>
<li>We track changes to the way we handle inputs to <code>tdms</code>, and the system tests. Ensuring we test against unexpected behaviour due to input changes.</li>
</ul>
<h3><a class="anchor" id="autotoc_md22"></a>
(Re)generation of the Data</h3>
<p>(Re)generating the input data for a particular test case, <code>arc_XX</code>, is a three-step process:</p><ol type="1">
<li>Determine variables, filenames, and the particular setup of <code>arc_XX</code>. This information is stored in the corresponding <code>config_XX.yaml</code> file. For example, is an illumination file required? What are the spatial obstacles? What is the solver method?</li>
</ol>
<ol type="1">
<li>Call the <code>run_bscan.m</code> function (and sub-functions in <code>./matlab</code>) using the information in <code>config_XX.yaml</code> to produce the <code>.mat</code> input files. Each test case requires an input file (<code>input_file_XX.m</code>) which defines test-specific variables (domain size, number of period cells, material properties, etc) which are too complex to specify in a <code>.yaml</code> file.</li>
</ol>
<ol type="1">
<li>Clean up the auxillary <code>.mat</code> files that are generated by this process. In particular, any <code>gridfiles.mat</code>, illumination files, or other <code>.mat</code> files that are temporarily created when generating the input <code>.mat</code> file.</li>
</ol>
<h3><a class="anchor" id="autotoc_md23"></a>
Contents of the &lt;tt&gt;data/input_generation&lt;/tt&gt; Directory (and subdirectories)</h3>
<p>The <code>run_bscan</code> function is inside the <code>bscan/</code> directory.</p>
<p>The <code>matlab/</code> directory contains functions that <code>run_bscan</code> will need to call on during the creation of the input data. This in particular includes the <code>iteratefdtd_matrix</code> function, which does the majority of the work in setting up gridfiles, illumination files, and the <code>.mat</code> inputs themselves.</p>
<p>The <code>generate_test_input.py</code> file contains <code>.py</code> files that the system tests can invoke to regenerate the input data. Since the system test framework uses <code>pytest</code>, but the data generation requires <code>MATLAB</code> (for now), we use <code>Python</code> to read in and process the information that each test requires, and then call <code>run_bscan</code> with the appropriate commands from within Python.</p>
<p>The <code>regenerate_all.py</code> file will work through all of the <code>config_tc.yaml</code> files in the directory and regenerate the input <code>.mat</code> data corresponding to each.</p>
<p>The remaining <code>config_XX.yaml</code> and <code>input_file_XX.m</code> files are as mentioned in the previous section. These contain the information about each test that Python and <code>run_bscan</code> will need to regenerate the input files. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
